# ansible-playbook deploy.yaml -i inventories/dev/hosts --vault-id ~/.tokens/master_id

- hosts: all
  strategy: free

  tasks:

    - name: 'Ensure existence of configuration directory: {{ app_data }}/certs'
      command: mkdir -p {{ app_data }}/certs
      args:
        warn: no
      become: yes
      become_user: "{{ user }}"

    - name: Render public certificates
      ansible.builtin.copy:
        content: '{{ item.cert }}'
        dest: '{{ app_data }}/certs/{{ item.common_name }}.cert'
      with_items: '{{ certs }}'
      loop_control:
        label: "{{ item.common_name }}.cert"
      when: certs is defined

    - name: Render private keys
      ansible.builtin.copy:
        content: '{{ item.key }}'
        dest: '{{ app_data }}/certs/{{ item.common_name }}.key'
      with_items: '{{ certs }}'
      loop_control:
        label: "{{ item.common_name }}.key"
      when: certs is defined

    - name: 'Render dynamic configuration to {{ app_data }}/traefik.yaml'
      template:
        src: traefik.yaml.j2
        dest: "{{ app_data }}/traefik.yaml"
      become: yes
      become_user: "{{ user }}"

    - name: Render docker-compose.yaml & deploy stack
      import_role:
        name: docker-deploy
      vars:
        with_registry: no
